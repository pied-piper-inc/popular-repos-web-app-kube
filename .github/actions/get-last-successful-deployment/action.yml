name: 'Get Last Successful Deployment'
description: "Returns the last successful deployment for a given environment"
inputs:
  environment:
    description: "Environment to check"
outputs:
  deployment-sha:
    description: "Git sha for last successful deployment"
    value: ${{steps.get-last-successful-deployment.outputs.deployment-sha}}
  deployment:
    description: "Deployment JSON"
    value: ${{steps.get-last-successful-deployment.outputs.deployment}}
runs:
  using: "composite"
  steps:
  - uses: actions/github-script@v5
    id: get-last-successful-deployment
    with:
      script: |
        const result = await github.request('GET /repos/{owner}/{repo}/deployments', {
                                owner: context.repo.owner,
                                repo: context.repo.repo
                              })
        const deployments = result.data.filter(deployment => deployment.environment === '${{ inputs.environment }}')
        var last_successful_deployment = null;
        for (const deployment of deployments) {
          core.debug(deployment.url)
          const deployment_statuses = await github.request(deployment.statuses_url)
          if(deployment_statuses.data[0].state === 'success') {
            last_successful_deployment = deployment
            break
          }
        }
        core.debug(last_successful_deployment)
        core.setOutput('deployment', JSON.stringify(last_successful_deployment))
        core.setOutput('deployment-sha', last_successful_deployment.sha)